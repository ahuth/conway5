<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="data:,">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Conway's game of life in WebAssembly" />
    <title>Conway5</title>
  </head>
  <body>
    <div>
      <button id="toggle">Play</button>
    </div>
    <canvas
      id="canvas"
      width="750"
      height="750"
      style="image-rendering: crisp-edges;"
    >
    </canvas>
    <script type="module">
      import {
        memory,
        evolveCells,
        getCell,
        setCell,
        UNIVERSE_SIZE,
      } from "./build/release.js";

      const wasmByteMemoryArray = new Uint8Array(memory.buffer);
      const canvas = document.querySelector("#canvas");
      const toggle = document.querySelector("#toggle");
      const context = canvas.getContext("2d");
      const size = UNIVERSE_SIZE.value;
      const cellHeight = canvas.height / size;
      const cellWidth = canvas.width / size;

      let playing = false;

      randomize();

      toggle.addEventListener('click', () => {
        if (playing) {
          playing = false;
          toggle.textContent = 'Start';
        } else {
          playing = true;
          toggle.textContent = 'Stop';
          window.requestAnimationFrame(draw);
        }
      });

      function randomize() {
        const rand = () => Math.floor(Math.random() * 50);

        for (let i = 0; i < 500; i++) {
          setCell(rand(), rand(), 1);
        }
      }

      function draw() {
        if (!playing) { return; }

        evolveCells();

        // Clear the canvas
        context.clearRect(0, 0, canvas.width, canvas.height);

        // Draw the cells.
        for (let x = 0; x < size; x++) {
          for (let y = 0; y < size; y++) {
            if (getCell(x, y)) {
              context.fillRect(x * cellWidth, y * cellHeight, cellWidth, cellHeight);
            }
          }
        }

        window.requestAnimationFrame(draw);
      }
    </script>
  </body>
</html>
